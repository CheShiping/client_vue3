# 🚨 文件上传问题 - 紧急修复指南

## 问题症状
学生上传文件时提示"无法获取学生信息，请重新登录"

## 根本原因
浏览器 localStorage 中缺少 `student_id` 字段

## ✅ 立即执行以下步骤（5分钟解决）

### 第 1 步：打开诊断工具

在浏览器中打开：
```
file:///D:/Desktop/前端期末项目/client_vue3/诊断工具.html
```

或者直接双击项目根目录下的 `诊断工具.html` 文件

### 第 2 步：点击"检查登录信息"按钮

查看诊断结果：
- ✅ 如果显示"student_id 存在"，说明可以上传文件
- ❌ 如果显示"student_id 不存在"，继续下一步

### 第 3 步：点击"测试登录（student001）"按钮

查看 API 响应：
- ✅ 如果 API 返回了 student_id，说明后端正常
- ❌ 如果 API 没有返回 student_id，说明后端有问题

### 第 4 步：点击"清除缓存并刷新"按钮

这会清除所有旧的缓存数据

### 第 5 步：重新登录系统

1. 访问：http://localhost:3003
2. 使用以下账号登录：
   - 用户名：`student001`
   - 密码：`123456`

### 第 6 步：验证登录成功

再次打开诊断工具，点击"检查登录信息"，确认：
- ✅ student_id 存在
- ✅ user_group 是 "student"

### 第 7 步：上传文件

1. 进入"答辩材料管理"
2. 点击"上传材料"
3. 选择材料类型
4. 选择文件
5. 点击"确定上传"

## 🎯 快速测试（30秒）

在浏览器控制台（F12）执行：

```javascript
// 1. 检查当前登录信息
console.log('当前用户信息:', JSON.parse(localStorage.getItem('userInfo') || '{}'))

// 2. 如果没有 student_id，清除缓存
localStorage.clear()

// 3. 刷新页面
location.reload()

// 4. 重新登录（使用 student001 / 123456）
```

## 📋 测试账号

### 学生账号（可以上传文件）
| 用户名 | 密码 | 说明 |
|--------|------|------|
| student001 | 123456 | 王同学（student_id: 8） |
| student002 | 123456 | 赵同学（student_id: 9） |

⚠️ **重要**：是 `student001`（三个零），不是 `student1`

### 教师账号（可以下载文件）
| 用户名 | 密码 | 说明 |
|--------|------|------|
| teacher001 | 123456 | 张教授 |
| teacher002 | 123456 | 李老师 |

## 🔍 如何确认问题已解决

### 方法 1：使用诊断工具
打开 `诊断工具.html`，点击"检查登录信息"，看到：
```
✓ student_id 存在: 8
✓ 可以上传文件！
```

### 方法 2：使用浏览器控制台
按 F12，在控制台输入：
```javascript
JSON.parse(localStorage.getItem('userInfo'))
```

应该看到：
```json
{
  "token": "mock_token_...",
  "user_id": 16,
  "username": "student001",
  "user_group": "student",
  "student_id": 8  ← 这个字段必须存在！
}
```

### 方法 3：尝试上传文件
如果能成功上传文件，说明问题已解决

## ⚠️ 常见错误

### 错误 1：使用了错误的账号
- ❌ 错误：student1
- ✅ 正确：student001（三个零）

### 错误 2：没有清除缓存
- 旧的 localStorage 数据会导致问题
- 必须清除后重新登录

### 错误 3：后端服务器没有运行
检查后端是否运行：
```bash
# 在 backend 目录下
node index.js
```

应该看到：
```
成功连接到MySQL服务器
数据库 defense_management_system 创建成功（或已存在）
...
后端服务器运行在端口 5000
```

### 错误 4：前端服务器没有运行
检查前端是否运行：
```bash
# 在项目根目录
npm run dev
```

应该看到：
```
VITE v... ready in ...ms
➜  Local:   http://localhost:3003/
```

## 🎉 成功标志

当您看到以下情况时，说明一切正常：

1. ✅ 诊断工具显示"student_id 存在"
2. ✅ localStorage 中有 student_id 字段
3. ✅ 可以进入"答辩材料管理"页面
4. ✅ 点击"上传材料"按钮有响应
5. ✅ 选择文件后可以成功上传
6. ✅ 上传后文件出现在列表中
7. ✅ 控制台显示"上传成功"

## 📞 仍然无法解决？

请提供以下信息：

1. **诊断工具的截图**
   - 特别是"检查登录信息"和"测试登录"的结果

2. **浏览器控制台的输出**
   ```javascript
   JSON.parse(localStorage.getItem('userInfo'))
   ```

3. **上传时的控制台日志**
   - 包括所有错误信息

4. **后端控制台的输出**
   - 查看是否有错误信息

## 🔧 终极解决方案

如果以上所有方法都不行，执行以下步骤：

1. **完全关闭浏览器**（所有窗口）
2. **重启后端服务器**
   ```bash
   # 停止后端（Ctrl+C）
   cd backend
   node index.js
   ```
3. **重启前端服务器**
   ```bash
   # 停止前端（Ctrl+C）
   npm run dev
   ```
4. **打开新的浏览器窗口**
5. **访问诊断工具**
6. **点击"清除缓存并刷新"**
7. **使用 student001 / 123456 登录**
8. **验证 student_id 存在**
9. **尝试上传文件**

---

**最后更新**：2026-01-14

**系统状态**：
- ✅ 后端服务器运行正常（端口 5000）
- ✅ 前端服务器运行正常（端口 3003）
- ✅ 数据库连接正常
- ✅ 登录 API 返回 student_id
- ✅ 文件上传 API 工作正常

**问题根源**：浏览器缓存中的旧数据

**解决方案**：清除缓存 + 重新登录
