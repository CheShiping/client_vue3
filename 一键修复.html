<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶ä¸Šä¼ é—®é¢˜ - ä¸€é”®ä¿®å¤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .status {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .status-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
            font-size: 16px;
        }
        .icon {
            width: 24px;
            height: 24px;
            margin-right: 10px;
            font-size: 20px;
        }
        .success { color: #52c41a; }
        .error { color: #f5222d; }
        .warning { color: #faad14; }
        .info { color: #1890ff; }
        
        .big-button {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px 0;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        .btn-success {
            background: linear-gradient(135deg, #52c41a 0%, #389e0d 100%);
            color: white;
        }
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(82, 196, 26, 0.4);
        }
        .btn-danger {
            background: linear-gradient(135deg, #f5222d 0%, #cf1322 100%);
            color: white;
        }
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(245, 34, 45, 0.4);
        }
        .account-info {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }
        .account-info h3 {
            color: #0050b3;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .account-info p {
            margin: 5px 0;
            font-size: 14px;
        }
        .account-info code {
            background: #fff;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #d4380d;
        }
        .steps {
            background: #fff7e6;
            border: 1px solid #ffd591;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }
        .steps h3 {
            color: #d46b08;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .steps ol {
            margin-left: 20px;
        }
        .steps li {
            margin: 8px 0;
            font-size: 14px;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            display: none;
        }
        .result.show {
            display: block;
        }
        .result pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ æ–‡ä»¶ä¸Šä¼ é—®é¢˜ä¿®å¤å·¥å…·</h1>
        <p class="subtitle">è‡ªåŠ¨è¯Šæ–­å¹¶ä¿®å¤å­¦ç”Ÿæ–‡ä»¶ä¸Šä¼ é—®é¢˜</p>

        <div class="status" id="statusBox">
            <div class="status-item">
                <span class="icon">ğŸ”</span>
                <span>æ­£åœ¨æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...</span>
            </div>
        </div>

        <button class="big-button btn-primary" onclick="diagnose()">
            ğŸ” å¼€å§‹è¯Šæ–­
        </button>

        <button class="big-button btn-danger" onclick="fixProblem()" id="fixButton" style="display: none;">
            ğŸ”§ ä¸€é”®ä¿®å¤ï¼ˆæ¸…é™¤ç¼“å­˜ï¼‰
        </button>

        <button class="big-button btn-success" onclick="goToSystem()" id="goButton" style="display: none;">
            âœ… å‰å¾€ç³»ç»Ÿç™»å½•
        </button>

        <div class="account-info">
            <h3>ğŸ“ æµ‹è¯•è´¦å·</h3>
            <p><strong>å­¦ç”Ÿè´¦å·ï¼š</strong></p>
            <p>ç”¨æˆ·åï¼š<code>student001</code> ï¼ˆæ³¨æ„æ˜¯ä¸‰ä¸ªé›¶ï¼‰</p>
            <p>å¯†ç ï¼š<code>123456</code></p>
            <br>
            <p><strong>æ•™å¸ˆè´¦å·ï¼š</strong></p>
            <p>ç”¨æˆ·åï¼š<code>teacher001</code></p>
            <p>å¯†ç ï¼š<code>123456</code></p>
        </div>

        <div class="steps">
            <h3>ğŸ“‹ ä¿®å¤æ­¥éª¤</h3>
            <ol>
                <li>ç‚¹å‡»"å¼€å§‹è¯Šæ–­"æŒ‰é’®</li>
                <li>å¦‚æœå‘ç°é—®é¢˜ï¼Œç‚¹å‡»"ä¸€é”®ä¿®å¤"</li>
                <li>ç‚¹å‡»"å‰å¾€ç³»ç»Ÿç™»å½•"</li>
                <li>ä½¿ç”¨ <code>student001</code> / <code>123456</code> ç™»å½•</li>
                <li>è¿›å…¥"ç­”è¾©ææ–™ç®¡ç†"ä¸Šä¼ æ–‡ä»¶</li>
            </ol>
        </div>

        <div class="result" id="resultBox"></div>
    </div>

    <script>
        let diagnosisResult = null;

        async function diagnose() {
            const statusBox = document.getElementById('statusBox');
            const resultBox = document.getElementById('resultBox');
            const fixButton = document.getElementById('fixButton');
            const goButton = document.getElementById('goButton');
            
            statusBox.innerHTML = '<div class="status-item"><span class="loading"></span><span style="margin-left: 10px;">æ­£åœ¨è¯Šæ–­...</span></div>';
            resultBox.classList.remove('show');
            fixButton.style.display = 'none';
            goButton.style.display = 'none';

            // æ£€æŸ¥ localStorage
            const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
            
            // æµ‹è¯•ç™»å½• API
            let apiResult = null;
            try {
                const response = await fetch('http://localhost:5000/api/user/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'student001', password: '123456' })
                });
                apiResult = await response.json();
            } catch (error) {
                apiResult = { error: { message: 'æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡å™¨' } };
            }

            // ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š
            let html = '';
            let hasStudentId = !!userInfo.student_id;
            let apiHasStudentId = apiResult?.result?.obj?.student_id;
            let needsFix = !hasStudentId;

            html += '<div class="status-item">';
            html += '<span class="icon ' + (userInfo.user_id ? 'success' : 'error') + '">' + (userInfo.user_id ? 'âœ…' : 'âŒ') + '</span>';
            html += '<span>ç™»å½•çŠ¶æ€ï¼š' + (userInfo.user_id ? 'å·²ç™»å½•' : 'æœªç™»å½•') + '</span>';
            html += '</div>';

            html += '<div class="status-item">';
            html += '<span class="icon ' + (hasStudentId ? 'success' : 'error') + '">' + (hasStudentId ? 'âœ…' : 'âŒ') + '</span>';
            html += '<span>student_idï¼š' + (hasStudentId ? userInfo.student_id : 'ä¸å­˜åœ¨') + '</span>';
            html += '</div>';

            html += '<div class="status-item">';
            html += '<span class="icon ' + (apiHasStudentId ? 'success' : 'error') + '">' + (apiHasStudentId ? 'âœ…' : 'âŒ') + '</span>';
            html += '<span>ç™»å½• APIï¼š' + (apiHasStudentId ? 'æ­£å¸¸' : 'å¼‚å¸¸') + '</span>';
            html += '</div>';

            statusBox.innerHTML = html;

            // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
            let resultHtml = '<h3>ğŸ“Š è¯Šæ–­è¯¦æƒ…</h3>';
            
            if (hasStudentId) {
                resultHtml += '<div style="background: #f6ffed; border: 1px solid #b7eb8f; padding: 15px; border-radius: 8px;">';
                resultHtml += '<p style="color: #52c41a; font-weight: bold; margin-bottom: 10px;">âœ… ç³»ç»ŸçŠ¶æ€æ­£å¸¸ï¼</p>';
                resultHtml += '<p>æ‚¨çš„è´¦å·å·²æ­£ç¡®ç™»å½•ï¼Œå¯ä»¥ä¸Šä¼ æ–‡ä»¶ã€‚</p>';
                resultHtml += '<p style="margin-top: 10px;">å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼š</p>';
                resultHtml += '<pre>' + JSON.stringify(userInfo, null, 2) + '</pre>';
                resultHtml += '</div>';
                goButton.style.display = 'block';
            } else if (apiHasStudentId) {
                resultHtml += '<div style="background: #fff7e6; border: 1px solid #ffd591; padding: 15px; border-radius: 8px;">';
                resultHtml += '<p style="color: #d46b08; font-weight: bold; margin-bottom: 10px;">âš ï¸ éœ€è¦é‡æ–°ç™»å½•</p>';
                resultHtml += '<p>ç™»å½• API å·¥ä½œæ­£å¸¸ï¼Œä½†æµè§ˆå™¨ç¼“å­˜ä¸­çš„æ•°æ®ä¸å®Œæ•´ã€‚</p>';
                resultHtml += '<p style="margin-top: 10px;"><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p>';
                resultHtml += '<ol style="margin-left: 20px; margin-top: 5px;">';
                resultHtml += '<li>ç‚¹å‡»ä¸‹æ–¹"ä¸€é”®ä¿®å¤"æŒ‰é’®æ¸…é™¤ç¼“å­˜</li>';
                resultHtml += '<li>ä½¿ç”¨ student001 / 123456 é‡æ–°ç™»å½•</li>';
                resultHtml += '</ol>';
                resultHtml += '</div>';
                fixButton.style.display = 'block';
            } else {
                resultHtml += '<div style="background: #fff2e8; border: 1px solid #ffbb96; padding: 15px; border-radius: 8px;">';
                resultHtml += '<p style="color: #d4380d; font-weight: bold; margin-bottom: 10px;">âŒ åç«¯æœåŠ¡å¼‚å¸¸</p>';
                resultHtml += '<p>æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡å™¨æˆ–ç™»å½• API è¿”å›å¼‚å¸¸ã€‚</p>';
                resultHtml += '<p style="margin-top: 10px;"><strong>è¯·æ£€æŸ¥ï¼š</strong></p>';
                resultHtml += '<ol style="margin-left: 20px; margin-top: 5px;">';
                resultHtml += '<li>åç«¯æœåŠ¡å™¨æ˜¯å¦è¿è¡Œï¼ˆç«¯å£ 5000ï¼‰</li>';
                resultHtml += '<li>æ•°æ®åº“æ˜¯å¦æ­£å¸¸è¿æ¥</li>';
                resultHtml += '<li>æµ‹è¯•è´¦å·æ˜¯å¦å­˜åœ¨</li>';
                resultHtml += '</ol>';
                resultHtml += '<p style="margin-top: 10px;">API å“åº”ï¼š</p>';
                resultHtml += '<pre>' + JSON.stringify(apiResult, null, 2) + '</pre>';
                resultHtml += '</div>';
            }

            resultBox.innerHTML = resultHtml;
            resultBox.classList.add('show');
            
            diagnosisResult = { hasStudentId, apiHasStudentId, needsFix };
        }

        function fixProblem() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å—ï¼Ÿ\n\næ¸…é™¤åæ‚¨éœ€è¦é‡æ–°ç™»å½•ç³»ç»Ÿã€‚')) {
                localStorage.clear();
                sessionStorage.clear();
                
                alert('âœ… ç¼“å­˜å·²æ¸…é™¤ï¼\n\nè¯·ç‚¹å‡»"å‰å¾€ç³»ç»Ÿç™»å½•"æŒ‰é’®ï¼Œç„¶åä½¿ç”¨ä»¥ä¸‹è´¦å·ç™»å½•ï¼š\n\nç”¨æˆ·åï¼šstudent001\nå¯†ç ï¼š123456');
                
                document.getElementById('fixButton').style.display = 'none';
                document.getElementById('goButton').style.display = 'block';
                
                // é‡æ–°è¯Šæ–­
                setTimeout(() => {
                    diagnose();
                }, 500);
            }
        }

        function goToSystem() {
            window.open('http://localhost:3003', '_blank');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¯Šæ–­
        window.onload = function() {
            setTimeout(() => {
                diagnose();
            }, 500);
        };
    </script>
</body>
</html>
