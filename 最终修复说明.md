# 文件上传功能 - 最终修复说明

## ✅ 问题根源

**问题**：学生上传文件时显示"服务器错误"

**根本原因**：
- 登录 API 只返回了 `user_id`，没有返回 `student_id`
- 前端上传文件时需要 `student_id`，但从 localStorage 中获取的是 `undefined`
- 后端收到 `student_id: 'undefined'` 字符串，无法插入数据库

## 🔧 修复内容

### 1. 修改登录 API
- 当用户是学生时，额外查询学生表获取 `student_id`
- 当用户是教师时，额外查询教师表获取 `teacher_id`
- 将这些 ID 包含在登录响应中

### 2. 登录响应现在包含
```javascript
{
  token: "...",
  user_id: 1,
  username: "student1",
  nickname: "学生1",
  user_group: "student",
  student_id: 1,  // ← 新增：学生ID
  // 或
  teacher_id: 1   // ← 新增：教师ID（如果是教师）
}
```

## 🎯 现在请重新测试

### 重要：必须重新登录！

由于修改了登录 API，您需要：

1. **退出登录**
   - 点击右上角退出按钮

2. **清除浏览器缓存**（可选但推荐）
   - 按 `Ctrl + Shift + R`

3. **重新登录**
   - 访问：http://localhost:3003
   - 使用学生账号登录：
     - 用户名：`student1`
     - 密码：`123456`

4. **上传文件**
   - 进入"答辩材料管理"
   - 点击"上传材料"
   - 选择材料类型
   - 选择文件
   - 点击"确定上传"

## 📋 测试账号

### 学生账号（可以上传文件）
- student1 / 123456
- student2 / 123456
- student3 / 123456
- student4 / 123456
- student5 / 123456

### 教师账号（可以下载学生文件）
- teacher1 / 123456
- teacher2 / 123456
- teacher3 / 123456

### 管理员账号
- admin / 123456

## 🔍 验证修复成功

### 检查登录信息
1. 登录后，按 `F12` 打开开发者工具
2. 在 Console 中输入：
   ```javascript
   JSON.parse(localStorage.getItem('userInfo'))
   ```
3. 应该能看到 `student_id` 字段（如果是学生账号）

### 检查上传功能
1. 上传文件后应该显示"上传成功"
2. 文件应该出现在列表中
3. 可以下载刚上传的文件

## 📝 支持的文件类型

- PDF 文档（.pdf）
- Word 文档（.doc, .docx）
- PowerPoint（.ppt, .pptx）
- 压缩文件（.zip, .rar）
- 最大文件大小：50MB

## 🎓 材料类型

- 答辩PPT
- 论文终稿
- 开题报告
- 中期报告
- 外文翻译
- 其他材料

## ⚠️ 重要提示

1. **必须重新登录**
   - 旧的登录信息没有 `student_id`
   - 必须退出后重新登录才能获取新的用户信息

2. **确保访问正确的地址**
   - 前端：http://localhost:3003
   - 后端：http://localhost:5000

3. **文件存储位置**
   - 上传的文件保存在：`backend/uploads/` 目录

## 🔧 技术细节

### 修改的文件
- `backend/index.js` - 登录 API

### 修改的逻辑
```javascript
// 登录时额外查询学生/教师ID
if (user.user_group === 'student') {
  const [studentRows] = await pool.query(
    'SELECT student_id FROM students WHERE user_id = ?',
    [user.user_id]
  );
  if (studentRows.length > 0) {
    userInfo.student_id = studentRows[0].student_id;
  }
}
```

## 🎉 预期结果

- ✅ 学生可以成功上传文件
- ✅ 上传后文件出现在列表中
- ✅ 可以下载已上传的文件
- ✅ 可以删除自己上传的文件
- ✅ 教师可以查看和下载学生上传的文件

现在请**退出登录，重新登录**，然后测试文件上传功能！
